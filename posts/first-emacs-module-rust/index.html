<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Writing an Emacs module in Rust - Ryan Faulhaber</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Recently I learned that Emacs supports linking with dynamic modules, so I tried writing one in Rust."><meta property="og:image" content><meta property="og:url" content="/posts/first-emacs-module-rust/"><meta property="og:site_name" content="Ryan Faulhaber"><meta property="og:title" content="Writing an Emacs module in Rust"><meta property="og:description" content="Recently I learned that Emacs supports linking with dynamic modules, so I tried writing one in Rust."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-14T14:30:00-04:00"><meta property="article:modified_time" content="2020-08-14T14:30:00-04:00"><meta property="article:tag" content="Rust"><meta property="article:tag" content="Emacs"><meta property="article:tag" content="Experiment"><meta name=twitter:card content="summary"><meta name=twitter:title content="Writing an Emacs module in Rust"><meta name=twitter:description content="Recently I learned that Emacs supports linking with dynamic modules, so I tried writing one in Rust."><link href=/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=/css/main.5cebd7d4fb2b97856af8d32a6def16164fcf7d844e98e236fcb3559655020373.css><link id=darkModeStyle rel=stylesheet type=text/css href=/css/dark.d22e2a2879d933a4b781535fc4c4c716e9f9d35ea4986dd0cbabda82effc4bdd.css media="(prefers-color-scheme: dark)"></head><body><div class=content><header><div class=main><a href=/>Ryan Faulhaber</a></div><nav><a href=posts/>posts</a>
<a href=resume/>resume</a>
<a href=working/>working with me</a></nav></header><main><article><div class=title><h1 class=title>Writing an Emacs module in Rust</h1><div class=meta>Posted on Aug 14, 2020</div></div><section class=body><p>Recently I learned that Emacs supports linking with dynamic modules, so I tried writing one in Rust.</p><p>I&rsquo;m a new Emacs user. I made the jump to Emacs from VSCode / IntelliJ / Vim back in March, and it&rsquo;s been a mind-blowing experience. I cannot sing Emacs&rsquo;s praise enough, it&rsquo;s a truly incredible piece of software.</p><p>I&rsquo;m also a new Rust developer. I don&rsquo;t write Rust professionally but I made my way through the wonderful and informative <a href=https://doc.rust-lang.org/book/>Rust book</a> and I fell head-over-heels for this language. I never thought of myself as having any interest in systems programming until I learned Rust, and Rust has allowed me to very easily bridge that gap.</p><p>So recently I learned that Emacs allows you to write dynamically-loaded modules written in C. In case you don&rsquo;t know, if you want to customize Emacs, you must write Emacs Lisp code. This is no different than if you want to customize VS Code and writing JavaScript or TypeScript, although Emacs Lisp is far more robust in terms of what it will allow you to customize. Not all Emacs Lisp code is written in Emacs Lisp, though. Some functions that have to interact with the system on a lower-level <a href=https://www.gnu.org/software/emacs/manual/html%5Fnode/eintr/Primitive-Functions.html#Primitive-Functions>are written in C</a> but can be called like Emacs Lisp functions. Emacs also lets you write such functions yourself.</p><p>I would hardly consider myself an expert in the fields of C or systems programming, but I&rsquo;ve always wanted a good excuse to mess around with rust-bindgen. I also realize there&rsquo;s already <a href=https://github.com/ubolonton/emacs-module-rs>Emacs bindings for Rust</a>, but for the sake of learning we&rsquo;ll ignore that for now.</p><p>Here&rsquo;s how I tried to write a module for Emacs in Rust.</p><h2 id=how-it-works>How it works</h2><p>According to the <a href=https://www.gnu.org/software/emacs/manual/html%5Fnode/elisp/Module-Initialization.html#Module-Initialization>Emacs documentation</a> on the matter, if we were writing C, writing an Emacs module requires the following steps:</p><ol><li>Include the <code>emacs-module.h</code> header file</li><li>Specify <code>int plugin_is_GPL_compatible;</code> in your code</li><li>Implement the <code>emacs_module_init</code> function, which Emacs will call upon loading our module</li></ol><p>And that&rsquo;s pretty much it. But obviously we&rsquo;re dealing with Rust, so our plan of attack will instead be to generate bindings using <a href=https://github.com/rust-lang/rust-bindgen><code>rust-bindgen</code></a> and implement our init function in Rust.</p><h2 id=setup>Setup</h2><p>I started this like I begin all new Rust projects: by calling <code>cargo new --lib emacs-module-test</code>.</p><p>My Cargo.toml file was edited to contain the following:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>package</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;emacs-module-test&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;0.1.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>authors</span> = [<span style=color:#e6db74>&#34;Ryan Faulhaber &lt;faulhaberryan@gmail.com&gt;&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>edition</span> = <span style=color:#e6db74>&#34;2018&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># let&#39;s make our code GPL-compatible!</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>license</span> = <span style=color:#e6db74>&#34;GPL-3.0-or-later&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>lib</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>path</span> = <span style=color:#e6db74>&#34;src/lib.rs&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># we need to specify &#34;cdylib&#34; because our project has to output a shared object</span>
</span></span><span style=display:flex><span><span style=color:#75715e># file</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>crate-type</span> = [<span style=color:#e6db74>&#34;cdylib&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>dependencies</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># we&#39;ll need some help from libc to interact with C&#39;s types</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>libc</span> = <span style=color:#e6db74>&#34;0.2&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>build-dependencies</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># and of course we&#39;ll need bindgen</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bindgen</span> = <span style=color:#e6db74>&#34;0.54.1&#34;</span></span></span></code></pre></td></tr></table></div></div><p>Next, we&rsquo;ll a build step, as per bindgen&rsquo;s instructions:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// build.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>crate</span> bindgen;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::env;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::path::PathBuf;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> bindings <span style=color:#f92672>=</span> bindgen::Builder::default()
</span></span><span style=display:flex><span>        <span style=color:#75715e>// I just imported it straight from where it was on my computer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// If we were building a real module we might not want to do this!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Also if you&#39;re trying this on macOS this header file may not be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// in this particular location
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .header(<span style=color:#e6db74>&#34;/usr/include/emacs-module.h&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We want to specify our own emacs_module_init function, so we won&#39;t
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// generate one in Rust automatically
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .blacklist_function(<span style=color:#e6db74>&#34;emacs_module_init&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Generate the bindings
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .generate()
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Explode if something goes wrong
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .expect(<span style=color:#e6db74>&#34;Unable to generate bindings&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> out_path <span style=color:#f92672>=</span> PathBuf::from(env::var(<span style=color:#e6db74>&#34;OUT_DIR&#34;</span>).unwrap());
</span></span><span style=display:flex><span>    bindings
</span></span><span style=display:flex><span>        .write_to_file(out_path.join(<span style=color:#e6db74>&#34;bindings.rs&#34;</span>))
</span></span><span style=display:flex><span>        .expect(<span style=color:#e6db74>&#34;Couldn&#39;t write bindings!&#34;</span>);
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>This is mostly lifted straight from <code>rust-bindgen</code>&rsquo;s documentation.</p><p>Finally, we&rsquo;ll start the lib.rs file:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e>// this is also borrowed from rust-bindgen. C code obviously has different
</span></span></span><span style=display:flex><span><span style=color:#75715e>// stylistic conventions. For the sake of simplicity we&#39;ll write stylistically
</span></span></span><span style=display:flex><span><span style=color:#75715e>// unconventional code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#![allow(non_upper_case_globals)]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#![allow(non_camel_case_types)]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#![allow(non_snake_case)]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// this dumps the contents of bindings.rs into this file upon compilation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>include!(concat!(env!(<span style=color:#e6db74>&#34;OUT_DIR&#34;</span>), <span style=color:#e6db74>&#34;/bindings.rs&#34;</span>));</span></span></code></pre></td></tr></table></div></div><p>So far so good. The project should compile (<code>cargo build</code>) without issues. This would also be the time to drop <a href=https://www.gnu.org/licenses/gpl-3.0.en.html>a copy of the GPL-3.0 license</a> into a file called LICENSE.</p><h2 id=looking-through-bindings-dot-rs>Looking through <code>bindings.rs</code></h2><p>Before we get started we should take a look at the bindings that <code>rust-bindgen</code> generated. The path will be something different for you, but to give you a sense of where to look, the path on my machine was: <code>target/debug/build/emacs-module-84a415ae9d763afd/out/bindings.rs</code></p><p>There&rsquo;s a few types that we should make note of.</p><h3 id=emacs-runtime><code>emacs_runtime</code></h3><p>In the code we&rsquo;ll be writing Emacs provides us with an instance of this struct that represents the Emacs runtime, so we don&rsquo;t have to worry about creating it (I would be interested in mocking it though&mldr;). The most important part of this struct is the <code>get_environment</code> member, which is a function pointer. As the signature implies it returns an instance of <code>emacs_env</code>, so let&rsquo;s check that out.</p><h3 id=emacs-env><code>emacs_env</code></h3><p>Since I&rsquo;m running Emacs 26 there are two version of this struct. I&rsquo;m only concerned with <code>emacs_env_26</code>.</p><p>This is the more important struct, as a number of its members are function pointers to crucial functions we&rsquo;ll need to interact with Emacs. I won&rsquo;t go over them all now, but the ones that we&rsquo;ll be using are:</p><ul><li><code>make_function</code>, which creates the body of a function</li><li><code>make_string</code>, which converts a string from C (Rust) into an <code>emacs_value</code></li><li><code>intern</code>, which allows us to create symbols in Emacs</li><li><code>funcall</code>, which allows us to call Emacs functions and receive their return value</li></ul><h3 id=emacs-value><code>emacs_value</code></h3><p>This is a representation of a value in Emacs Lisp in C (Rust). It&rsquo;s not entirely clear to me how it works internally, but fortunately it doesn&rsquo;t really matter for what we&rsquo;re doing.</p><h2 id=writing-the-module>Writing the module</h2><p>For the sake of simplicity, we&rsquo;ll write a dead simple module, one that&rsquo;s so simple we could write it in Emacs Lisp:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(defun my-message-from-rust ()
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;Returns a message from Rust&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;Hello Emacs, I&#39;m from Rust&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(defun my-sum (<span style=color:#66d9ef>&amp;rest</span> args)
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;Returns the sum of ARGS&#34;</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>apply</span> <span style=color:#e6db74>&#39;+</span> args))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(provide <span style=color:#e6db74>&#39;my-rust-mod</span>)</span></span></code></pre></td></tr></table></div></div><p>Our module will provide two functions, <code>my-message-from-rust</code> and <code>my-sum</code>. The former simply returns a string literal, while the latter sums up all the values passed to it. That should be easy enough.</p><p>As I mentioned earlier, the documentation says that we&rsquo;ll have to implement a function called <code>emacs_module_init</code>. This is where our Rust code will define its functions.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>In Emacs, it&rsquo;s conventional to register your module with the list of features available to Emacs. The <code>provide</code> call tells Emacs that <code>'my-rust-mod</code> is now a feature within Emacs.</p><p>Let&rsquo;s at least set up the function first. Our <code>lib.rs</code> file should look like:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#![allow(non_upper_case_globals)]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#![allow(non_camel_case_types)]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#![allow(non_snake_case)]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// you shouldn&#39;t have to put this at the top of your file, but I noticed that
</span></span></span><span style=display:flex><span><span style=color:#75715e>// rust-analyer got a little confused on my computer when I put it after my code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>include!(concat!(env!(<span style=color:#e6db74>&#34;OUT_DIR&#34;</span>), <span style=color:#e6db74>&#34;/bindings.rs&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// we&#39;ll be using these later
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>use</span> std::ffi::CString;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::os::raw;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[no_mangle]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(non_upper_case_globals)]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Rust doesn&#39;t allow uninitialized static values, and Emacs doesn&#39;t care what
</span></span></span><span style=display:flex><span><span style=color:#75715e>// the value of this variable is, as long as it&#39;s there
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>static</span> plugin_is_GPL_compatible: <span style=color:#a6e22e>libc</span>::c_int <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ordinarily the Rust compiler will mangle funciton names. we don&#39;t want to do
</span></span></span><span style=display:flex><span><span style=color:#75715e>// that, since the C code won&#39;t know what code to call.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// we&#39;ll also want to use `unsafe` because we need access to raw pointers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#[no_mangle]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>unsafe</span> <span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>emacs_module_init</span>(ert: <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> emacs_runtime) -&gt; <span style=color:#a6e22e>libc</span>::c_int {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> env <span style=color:#f92672>=</span> (<span style=color:#f92672>*</span>ert)
</span></span><span style=display:flex><span>        .get_environment
</span></span><span style=display:flex><span>        <span style=color:#75715e>// for simplicity&#39;s sake we&#39;ll be getting a lot of mileage out of
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// .expect()!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .expect(<span style=color:#e6db74>&#34;cannot get environment from Emacs&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// remember, these are function pointers we&#39;re dealing with!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        (ert);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// to be used later
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> make_function <span style=color:#f92672>=</span> (<span style=color:#f92672>*</span>env).make_function.except(<span style=color:#e6db74>&#34;cannot get make_function!&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    todo!(<span style=color:#e6db74>&#34;Finish writing this function!&#34;</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>Now let&rsquo;s write some functions.</p><h3 id=my-message-from-rust><code>my-message-from-rust</code></h3><p>First, the actual Rust code:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// no need to no-mangle it since it&#39;ll never be called by name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>unsafe</span> <span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>message_from_rust</span>(
</span></span><span style=display:flex><span>    env: <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> emacs_env,
</span></span><span style=display:flex><span>    nargs: <span style=color:#66d9ef>isize</span>,
</span></span><span style=display:flex><span>    args: <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> emacs_value,
</span></span><span style=display:flex><span>    data: <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> raw::c_void,
</span></span><span style=display:flex><span>) -&gt; <span style=color:#a6e22e>emacs_value</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// our actual message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello Emacs! I&#39;m from Rust!&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// function pointer to make_string, provided by Emacs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> make_string <span style=color:#f92672>=</span> (<span style=color:#f92672>*</span>env).make_string.unwrap();
</span></span><span style=display:flex><span>    <span style=color:#75715e>// converted to a CString
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> c_string <span style=color:#f92672>=</span> CString::new(s).unwrap();
</span></span><span style=display:flex><span>    <span style=color:#75715e>// grab the size in bytes, as needed by Emacs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> len <span style=color:#f92672>=</span> c_string.as_bytes().len() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>isize</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// return the emacs_value returned by make_string
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    make_string(env, c_string.as_ptr(), len)
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>Now, let&rsquo;s return to our init function and add the following:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>let</span> my_message_func <span style=color:#f92672>=</span> make_function(
</span></span><span style=display:flex><span>    <span style=color:#75715e>// a reference to our Emacs environment, of course
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    env,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// min_arity argument
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// max_arity argument
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// our actual function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Some(message_from_rust),
</span></span><span style=display:flex><span>    <span style=color:#75715e>// docstring, so users can check the documentation for this funciton in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Emacs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    CString::new(<span style=color:#e6db74>&#34;This will print a nice message from Rust code!&#34;</span>)
</span></span><span style=display:flex><span>        .unwrap()
</span></span><span style=display:flex><span>        .as_ptr(),
</span></span><span style=display:flex><span>    <span style=color:#75715e>// data argument. we are not passing this function any additional data, so
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// we give it `null`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    std::ptr::null_mut(),
</span></span><span style=display:flex><span>);</span></span></code></pre></td></tr></table></div></div><p>What&rsquo;s important to note about what we&rsquo;re doing here is that we&rsquo;re creating a new function <em>value</em>. Functions in Emacs Lisp (and indeed any functional programming language I&rsquo;ve ever heard of) are just values, like integers or strings. Much like our call to <code>make_string</code> earlier, we&rsquo;re just creating a new value on Emacs&rsquo;s terms. In fact it&rsquo;s probably more like creating an anonymous function. If this was the only code we wrote, our users would have no way of calling our code from within Emacs. We&rsquo;ll get to that later, though.</p><h3 id=my-sum><code>my-sum</code></h3><p>This one is a bit more interesting because we want our function to accept an indefinite amount of arguments. The actual function code:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// again, no need to no-mangle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>unsafe</span> <span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>my_sum</span>(
</span></span><span style=display:flex><span>    env: <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> emacs_env,
</span></span><span style=display:flex><span>    nargs: <span style=color:#66d9ef>isize</span>,
</span></span><span style=display:flex><span>    args: <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> emacs_value,
</span></span><span style=display:flex><span>    data: <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> raw::c_void,
</span></span><span style=display:flex><span>) -&gt; <span style=color:#a6e22e>emacs_value</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Emacs provides us with a way of grabbing an integer value out of an
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// emacs_value object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> extract_integer <span style=color:#f92672>=</span> (<span style=color:#f92672>*</span>env)
</span></span><span style=display:flex><span>        .extract_integer
</span></span><span style=display:flex><span>        .expect(<span style=color:#e6db74>&#34;could not get extract_integer&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> numbers <span style=color:#f92672>=</span> Vec::new();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Emacs is kind enough to tell us how many values were passed to our
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// function, so we don&#39;t really have to worry about whether or not the size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// of `args` is the same as `nargs`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>..</span>nargs {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// pointer arithmetic! how unsafe!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        numbers.push(extract_integer(env, <span style=color:#f92672>*</span>args.offset(i)));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// some good old Rust iterators
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> sum <span style=color:#f92672>=</span> numbers.iter().fold(<span style=color:#ae81ff>0</span>, <span style=color:#f92672>|</span>acc, n<span style=color:#f92672>|</span> acc <span style=color:#f92672>+</span> n);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// again, we have to rely on Emacs to convert to the proper type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> make_integer <span style=color:#f92672>=</span> (<span style=color:#f92672>*</span>env).make_integer.expect(<span style=color:#e6db74>&#34;could not get make_integer&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    make_integer(env, sum)
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>And again, we have to register it with the system in a similar way to our other function.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>let</span> my_sum_func <span style=color:#f92672>=</span> make_function(
</span></span><span style=display:flex><span>    env,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// this is a special value provided to us by Emacs letting it know that we
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// want our fuction to accept an indefinite amount of arguments
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    emacs_variadic_function <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>isize</span>,
</span></span><span style=display:flex><span>    Some(my_sum),
</span></span><span style=display:flex><span>    CString::new(<span style=color:#e6db74>&#34;Sums a series of integers&#34;</span>)
</span></span><span style=display:flex><span>        .unwrap()
</span></span><span style=display:flex><span>        .as_ptr(),
</span></span><span style=display:flex><span>    std::ptr::null_mut(),
</span></span><span style=display:flex><span>);</span></span></code></pre></td></tr></table></div></div><h3 id=finishing-up-module-init>Finishing up module init</h3><p>As I mentioned earlier, we have to associate our new function values to names in order to call them. At the moment they&rsquo;re sort of floating out in the ether with only memory addresses to reference them, and that&rsquo;s not particularly useful.</p><p>First, we need some symbols to associate to these functions. A symbol in Lisp is more or less just an identifier, but in order to create them they must first be <em>interned</em>. This is where we can use the <code>intern</code> function.</p><p>Let&rsquo;s add the following to our init function:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>let</span> intern <span style=color:#f92672>=</span> (<span style=color:#f92672>*</span>env).intern.expect(<span style=color:#e6db74>&#34;could not get intern&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// creates &#34;my-message-from-rust symbol&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>let</span> my_message_sym <span style=color:#f92672>=</span> intern(env, CString::new(<span style=color:#e6db74>&#34;my-message-from-rust&#34;</span>).unwrap().as_ptr());
</span></span><span style=display:flex><span><span style=color:#75715e>// creates &#34;my-sum&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>let</span> my_sum_sym <span style=color:#f92672>=</span> intern(env, CString::new(<span style=color:#e6db74>&#34;my-sum&#34;</span>).unwrap().as_ptr());</span></span></code></pre></td></tr></table></div></div><p>Next, we&rsquo;ll need to associate our functions with said symbols:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// intern will return a symbol if it&#39;s already defined.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// we&#39;re going to use `fset` to associate our functions to symbols
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>let</span> fset <span style=color:#f92672>=</span> intern(env, CString::new(<span style=color:#e6db74>&#34;fset&#34;</span>).unwrap().as_ptr());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// we also want to actually call fset, so we&#39;ll need funcall
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>let</span> funcall <span style=color:#f92672>=</span> (<span style=color:#f92672>*</span>env).funcall.expect(<span style=color:#e6db74>&#34;could not get funcall&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// in Emacs Lisp this is like:
</span></span></span><span style=display:flex><span><span style=color:#75715e>// (fset &#39;my-message-from-rust (lambda () ...))
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>funcall(env, fset, <span style=color:#ae81ff>2</span>, [my_message_sym, my_message_func].as_mut_ptr());
</span></span><span style=display:flex><span>funcall(env, fset, <span style=color:#ae81ff>2</span>, [my_sum_sym, my_sum_func].as_mut_ptr());</span></span></code></pre></td></tr></table></div></div><p>Finally, we&rsquo;ll want to provide our new feature:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>let</span> provide <span style=color:#f92672>=</span> intern(env, CString::new(<span style=color:#e6db74>&#34;provide&#34;</span>).unwrap().as_ptr());
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> feat_name <span style=color:#f92672>=</span> intern(env, CString::new(<span style=color:#e6db74>&#34;my-rust-mod&#34;</span>).unwrap().as_ptr());
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> provide_args <span style=color:#f92672>=</span> [feat_name].as_mut_ptr();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// equivalent of (provide &#39;my-rust-mod)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>funcall(env, provide, <span style=color:#ae81ff>1</span>, provide_args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// and finally, we can return from this function!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>0</span></span></span></code></pre></td></tr></table></div></div><h2 id=does-it-work>Does it work?</h2><p>Let&rsquo;s run a <code>cargo build</code> to make sure everything at least compiles.</p><p>Rust should give us a file called <code>libemacs_module.so</code> in <code>target/debug</code> (or <code>libemacs_module.dylib</code> if you&rsquo;re on macOS) assuming your project name is called <code>emacs_module</code>. There are a few ways of trying to run our code:</p><ol><li><p>Open Emacs, run <code>(module-load "path/to/your/libemacs_module.so")</code>, and running the functions yourself</p></li><li><p>From the terminal, running:</p><pre><code class=language-bash>   emacs -Q -l path/to/your/libemacs_module.so --batch --eval '(message &quot;%s&quot; (my-message-from-rust))'
</code></pre></li></ol><p>Either way, the functions you defined in Rust should now be runnable from Emacs.</p><h2 id=things-i-couldn-t-figure-out>Things I couldn&rsquo;t figure out</h2><p>This article was written based on my own experience and process of writing the example code I&rsquo;ve walked you through. There&rsquo;s a few things, though, I don&rsquo;t understand about what I&rsquo;ve done:</p><ol><li>If I compile this with <code>cargo build --release</code>, I suddenly get type errors from Emacs. I suspect it&rsquo;s a configuration error but as of the time of writing this I&rsquo;m not sure what the issue is.</li><li>I&rsquo;m not sure how you&rsquo;d write an interactive function, if at all.</li><li>I&rsquo;m not sure how you&rsquo;d deal with more complex data types, like alists. How would you create them or manipulate them?</li><li>There&rsquo;s quite a bit of verbose <code>CString</code> construction happening. I found that if I put that behind a function I suddenly get segfaults. I&rsquo;m not sure why.</li><li>Similarly, refactoring this code to make <code>intern</code> its own Rust function leads to segfaults.</li></ol><h2 id=what-s-the-point-of-all-this>What&rsquo;s the point of all this?</h2><p>If you&rsquo;ve never used Emacs before and you&rsquo;ve read this whole thing, you might realize that Emacs isn&rsquo;t exactly a <em>normal</em> editor.<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> It&rsquo;s not every day we&rsquo;re compiling and linking code to our editor. But why would we want to do this? Here are two reasons I can think of:</p><ol><li>Performance. Emacs Lisp is often good enough (at least, in my experience) but for more significant computation it might not be a bad idea to offload that to Rust code.</li><li>Further extensibility. Emacs is already very extensible, and Emacs has decades of history behind it. Emacs Lisp can do a lot language-wise, but it has its limits. Code written in Rust (or even C, of course) wouldn&rsquo;t have such limits.</li></ol><p>In any event, I just think it&rsquo;s a pretty handy feature to have. Maybe in the future I&rsquo;ll be writing a more extensive dynamic module for Emacs!<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p><p>If you want to see the code I wrote, you can check it out <a href=https://github.com/rfaulhaber/emacs-module-test>here</a>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>One thing that gets lost in understanding how interpreted languages work is that things like function definitions, blocks of code that seemingly don&rsquo;t <em>do</em> anything until called, are also technically &ldquo;run.&rdquo; Interpreted languages will evaluate your files from top to bottom, &ldquo;doing&rdquo; stuff as they interpret your code. Whether or not those functions get called is another question. In the above Emacs Lisp example, we&rsquo;re defining two functions, which, if that file were to be evaluated by the Emacs Lisp interpreter, would create two function definitions within the environment. It wouldn&rsquo;t <em>call</em> them, but it would allow for them to be called later. This is why we&rsquo;re going to define our code within the init function.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Emacs&rsquo;s &ldquo;normalcy&rdquo; is relative, I think. The first draft of this article said: &ldquo;How many editors do you know that have a full blown language interpreter built into them?&rdquo; Though as I said that I realized I could think of at least two: VS Code and Atom, which, both running Chromium, have the V8 engine running them. If you&rsquo;ve never used Emacs it&rsquo;s hard to describe the world of difference between how Emacs Lisp interacts with the editor and how a VS Code plugin interacts with the editor. Atom might be closer in terms of &ldquo;hackability,&rdquo; but I still think Emacs simply cannot be beaten in this department. Having gotten to know Emacs as well as I have recently though it does feel like Emacs kind of anticipated Electron apps a little bit.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>I&rsquo;ll be using <a href=https://github.com/ubolonton/emacs-module-rs><code>emacs-module-rs</code></a> for that though!&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/rust>rust</a></li><li><a href=/tags/emacs>emacs</a></li><li><a href=/tags/experiment>experiment</a></li></ul></nav></div></article></main><footer><div style=display:flex></div><div class=footer-info>2024 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>